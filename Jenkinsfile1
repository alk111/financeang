pipeline {
  agent {
    label 'a1'
  }
  
  stages {
    stage('Build Docker Image') {
      steps {
        sh 'docker build -t my-image .'
      }
    }
    
    stage('Push to ECR') {
      steps {
        withCredentials([[$class: 'AmazonWebServicesCredentialsBinding', accessKeyVariable: 'AWS_ACCESS_KEY_ID', credentialsId: "a9b61b71-dfa8-4066-839a-5aa7377c9972", secretKeyVariable: 'AWS_SECRET_ACCESS_KEY']]) {
          sh '''
            
            # Configure AWS CLI with credentials
            
            aws configure set aws_access_key_id $AWS_ACCESS_KEY_ID
            aws configure set aws_secret_access_key $AWS_SECRET_ACCESS_KEY
            aws configure set region us-east-1
            
            # Add IAM policy for ecruser
            aws iam attach-user-policy --user-name newecr --policy-arn arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryPowerUser
            
            # Get ECR authorization token
            AWS_TOKEN=`aws ecr-public get-authorization-token --region us-east-1 --output text --query 'authorizationData[].authorizationToken' | base64 -d | cut -d: -f2`
            
            # Log in to ECR
            echo $AWS_TOKEN | docker login --username AWS --password-stdin public.ecr.aws/m2o2j6d0

            # Tag the Docker image with the ECR repository URI
            docker tag my-image public.ecr.aws/m2o2j6d0/jenkinsimg/my-image

            # Push the Docker image to ECR
            docker push public.ecr.aws/m2o2j6d0/jenkinsimg/my-image
          '''
        }
      }
    }
  }
}
